---
title: "Exponential Smoothing: Part 1"
author: "Timo Meiendresch"
date: "28/05/2019"
knit: (function(input_file, encoding) {
  out_dir <- 'html_outputs';
  rmarkdown::render(input_file,
  encoding=encoding,
  output_file=file.path(dirname(input_file), out_dir, 'FPP_7_ES.html'))})
---

```{r, message=FALSE, echo=FALSE}
rm(list=ls())
graphics.off()
```

```{r, message=FALSE}
# libraries
library("fpp2")
```

# Introduction

Basics:

- Weighted averages of past observations
- weights decaying exponentially as the observations get older
- Hence, more recent observation gets higher weight

## Simple exponential smoothing
The simplest form is called **simple exponential smoothing** (SES).

- Suitable for data with no clear trend and no seasonal pattern. 

```{r}
oil <- window(oil, start=1996)
autoplot(oil) + 
  ylab("Oil (millions of tonnes)") +
  xlab("Year")

```

Recall that the naive method simply took the last observation. Hence, the weight of the last observation was 1. On the other hand, averaging placed equal weight on all observations.

In simple exponential smoothing forecasts are calculated using weighted averages, where the weights decrease exponentially.

$$ \hat{y}_{T+1|T} = \alpha \, y_T + \alpha\,(1-\alpha)y_{T-1} + \alpha\,(1-\alpha)^2 y_{T-2} + \,... $$

where $0 \leq \alpha \leq 1$ is the smoothing parameter.

#### Weighted average form
Forecast at time $T+1$ is equal to a weighted average between the most recent observation $y_T$ and the previous forecast $\hat{y}_{T|T-1}$: 

$$\hat{y}_{T+1|t} = \alpha y_T + (1-\alpha) \hat{y}_{T|T-1}$$

Iterative substituion leads to 

$$ \hat{y}_{T+1|T} = \sum_{j=0}^{T-1} \alpha(1-\alpha)^j y_{T-j} + (1-\alpha)^T \ell_0$$
The last term becomes tiny for large T. So, the weighted average form leads to the same forecast equation stated at the beginning. 

#### Component form
State equations in component form. For now, in simple exponential smoothing, the only component included is the level $\ell_t$. Later, a trend $b_t$ and a seasonal component $s_t$ will be added. 

Component form of SES:

$$
\begin{align*}
  \text{Forecast equation}  && \hat{y}_{t+h|t} & = \ell_{t}\\
  \text{Smoothing equation} && \ell_{t}        & = \alpha y_{t} + (1 - \alpha)\ell_{t-1},
\end{align*}
$$

where $l_t$ is the level (smoothed value) of the series at time t. Setting $h=1$ gives the fitted values, setting $t=T$ gives the true forecasts beyond the training data. So far the component form of SES is not particularly useful, but it will be the easiest form to use if other components are added.

#### Flat forecasts
SES has a flat forecast function. All forecasted values are equal to the last level component (forecasts suitable if ts has no trend or seasonal component).

#### Optimisation
Method requires initialisation choosing two parameters:

- Value of $\alpha$
- initial level $l_0$

Estimate values from observed data and minimising the sum of squared residuals (SSE). Values of unknown parameters that minimise 

$$
SSE = \sum_{t=1}^T (y_t - \hat{y}_{t|t-1})^2 = \sum_{t=1}^T e_t^2 
$$

which poses a nonlinear minimisation problem. 

```{r}
# estimate parameters
fc <- ses(oil, h=5)

# summary
summary(fc)

# accuracy one-step-ahead
round(accuracy(fc),2)

autoplot(fc) +
  autolayer(fitted(fc), series ="Fitted") +
  ylab("Oil (millions of tonnes)") + xlab("Year")
```

Note that there is substantial uncertainty and so interpreting the point forecasts without accounting for the large uncertainty can be very misleading. 

## Trend methods
Holt extended SES to allow forecasting of data with trend. In addition to the level equation, a trend equation is added. 

$$
\begin{align*}
  \text{Forecast equation}&& \hat{y}_{t+h|t} &= \ell_{t} + hb_{t} \\
  \text{Level equation}   && \ell_{t} &= \alpha y_{t} + (1 - \alpha)(\ell_{t-1} + b_{t-1})\\
  \text{Trend equation}   && b_{t}    &= \beta^*(\ell_{t} - \ell_{t-1}) + (1 -\beta^*)b_{t-1},
\end{align*}
$$

- $l_t$ denotes an estimate of the level at time $t$
- $b_t$ denotes an estimate of the trend (slope) of the series at time t, 
- $\alpha$ is the smoothing parameter for the level
- $\beta^\star$ is the smoothing parameter for the trend.
- $h$ captures the trend and is equal to the last estimated level plus h times the last estimated trend value. 

Note that $l_t$ is a weighted average of observation $y_t$ and the one-step-ahead training forecast for time t, here given by $l_{t-1} + b_{t-1}$. 

The trend equation shows that $b_t$ is a weighted average of the estimated trend at time t based on $l_t - l_{t-1}$ and $b_{t-1}$, the previous estimate of the trend. 


```{r}
air <- window(ausair, start = 1990)
# estimate 
fc <- holt(air, h=5)

# look at smoothing pars and trend, level states. 
summary(fc)

autoplot(fc) 
```

#### Damped trend methods
Forecast's by Holt's linear method display a constant trend indefinitely into the future. This leads to overforecasting, especially for longer forecast horizons. 

A parameter that "dampens" the trend to a flat line some time in the future is introduced. 

Holt's method with damped trend:

$$
\begin{align*}
  \hat{y}_{t+h|t} &= \ell_{t} + (\phi+\phi^2 + \dots + \phi^{h})b_{t} \\
  \ell_{t} &= \alpha y_{t} + (1 - \alpha)(\ell_{t-1} + \phi b_{t-1})\\
  b_{t} &= \beta^*(\ell_{t} - \ell_{t-1}) + (1 -\beta^*)\phi b_{t-1}.
\end{align*}
$$

- $\phi$ is the damping parameter $0 < \phi < 1 $
- For $\phi = 1$, the method is identical to Holt's linear method. 
- For values between 0 and 1, $\phi$ dampens the trend so that it approaches a constant some time in the future.
- Usually damping is restricted to values for $\phi$ between 0.8 and a maximum of $.98$.

```{r}
# Example: holt vs. damped holt
fc <- holt(air, h=15)
fc2 <- holt(air, phi=0.9,damped=TRUE, h=15)

# 
autoplot(air) +
  autolayer(fc, series="Holt's method", PI=FALSE) +
  autolayer(fc2, series="Damped Holt's method", PI=FALSE) +
  ggtitle("Forecasts from Holt's method") + xlab("Year") +
  ylab("Air passengers in Australia (millions)") +
  guides(colour=guide_legend(title="Forecast"))
```

#### Comparison non-seasonal exponential smoothing

```{r}
# Example: Comparison SES, holt, damped holt
fc <- ses(livestock)
fc2 <- holt(livestock)
fc3 <- holt(livestock, damped=TRUE)

# plot
autoplot(livestock) +
  autolayer(fc, PI=FALSE, series="SES") +
  autolayer(fc2, PI=FALSE, series="Holt") +
  autolayer(fc3, PI=FALSE, series="Damped Holt") +
  ggtitle("Comparison exponential smoothing") +
  ylab("Sheep (in million)") +
  xlab("Year")

# errors (time series Cross-Validation)
e1 <- tsCV(livestock, ses, h=1)
e2 <- tsCV(livestock, holt, h=1)
e3 <- tsCV(livestock, holt, damped=TRUE, h=1)

# MSE
mse <- function(error){
  mean(error^2, na.rm=TRUE)
}

MSE <- data.frame(MSE_ses=mse(e1), 
                  MSE_holt=mse(e2), 
                  MSE_d_holt=mse(e3))
MSE[which.min(MSE)]

# mae
mae <- function(error){
  mean(abs(error), na.rm=TRUE)
}

MAE <- data.frame(MAE_ses=mae(e1), 
                  MAE_holt=mae(e2),
                  MAE_d_holt=mae(e3))
MAE[which.min(MAE)]
```

For MAE and MSE damped holt's method is best. Therefore, we will proceed with using the damped Holt's method and apply it to the whole data.

```{r}
fc <- holt(livestock, damped=TRUE)

fc[["model"]]
```

- Smoothing parameter for level $\alpha$ is close to one, showing that the level reacts strongly to each new observation.
- Smoothing parameter for the slope is essentially zero, indicating that the trend is not chanign over time.

```{r}
autoplot(fc)
```

## Holt-Winters' seasonal method
Extension of the Holt method to capture seasonality is called the **Holt-Winters seasonal method** consisting of the forecast equation and three smoothing equations. 
- one for the level $\ell_t$
- one for the trend $b_t$
- one for the seasonal component $s_t$, with corresponding smoothing parameters $\alpha, \beta^\star, \gamma$. 

$m$ is used to denote the frequency of seasonality, i.e. the number of seasons in a year. 

Two variations of the seasonal component: 

- **Additive method**: When seasonal variations are roughly constant through the series; seasonal component is expressed in absolute terms in the scale of the observed series
- **Multiplicative method**: When the seasonal variations are changing proportional to the level of the series; Seasonal component expressed in relative terms (percentages), series is seasonally adjusted by dividing through by the seasonal component.

#### Holt-Winters' additive method
The component form for the additive method: 

$$
\begin{align*}
  \hat{y}_{t+h|t} &= \ell_{t} + hb_{t} + s_{t+h-m(k+1)} \\
  \ell_{t} &= \alpha(y_{t} - s_{t-m}) + (1 - \alpha)(\ell_{t-1} + b_{t-1})\\
  b_{t} &= \beta^*(\ell_{t} - \ell_{t-1}) + (1 - \beta^*)b_{t-1}\\
  s_{t} &= \gamma (y_{t}-\ell_{t-1}-b_{t-1}) + (1-\gamma)s_{t-m},
\end{align*}
$$

- k is the integer part of $(h-1)/m$ so that the estimates of the seasonal indices used for forecasting come from the final year of the sample. 
- **Level equation:** Weighted average of seasonally adjusted observation $(y_t - s_{t-m})$ and non-seasonal forecast $(\ell_{t-1} + b_{t-1}$ for time t. 
- **Trend equation:** Identical to Holt's linear method.
- **Seasonal equation:** Weighted average between the current seasonal index $(y_t - \ell_{t-1} + b_{t+1})$ and seasonal index of the same season last year (i.e. m time periods ago). 

#### Holt-Winter's multiplicative method

Component form for the multiplicative method is: 

$$
\begin{align*}
  \hat{y}_{t+h|t} &= (\ell_{t} + hb_{t}) \, s_{t+h-m(k+1)} \\
  \ell_{t} &= \alpha(y_{t} / s_{t-m}) + (1 - \alpha)(\ell_{t-1} + b_{t-1})\\
  b_{t} &= \beta^*(\ell_{t} - \ell_{t-1}) + (1 - \beta^*)b_{t-1}\\
  s_{t} &= \gamma (y_{t}/(\ell_{t-1}+b_{t-1})) + (1-\gamma)s_{t-m}
\end{align*}
$$






